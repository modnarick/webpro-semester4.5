<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>The Interknot</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-LN+7fdVzj6u52u30Kp6M/trliBMCMKTyK833zpbD+pXdCLuTusPj697FH4R/5mcr" crossorigin="anonymous">
    <link href="https://fonts.googleapis.com/css2?family=Poppins&display=swap" rel="stylesheet">

    <style>
      body {
        font-family: 'Poppins', sans-serif;
      }

      video.bg-video {
    z-index: -1;
  }

  body {
  position: relative;
  z-index: 0;
}

    </style>
    

  </head>
  <body class="m-0 p-0 bg-black text-white">
    <div id="container">
  <video id="DEL" autoplay loop muted playsinline
  class="position-fixed top-0 start-0 w-100 h-100 object-fit-cover bg-video">
  <source src="delta orange.mp4" type="video/mp4">
</video>

    <div class="d-flex flex-column justify-content-center align-items-center text-lg-center" style="min-height:100vh; position:relative; z-index:1;">
  <div class="mb-1">
    <h1><strong>THE INTERKNOT</strong></h1>
  </div>
  <div class="mb-1">
    <p><i>the only place to post your commission</i></p>
  </div>
    <div>
  <button id="loginBtn" class="bg-dark text-warning"><span>Login</span></button>
  <button id="registerBtn" class="bg-dark text-warning"><span>Register</span></button>
  <button id="logoutBtn" class="bg-dark text-danger"><span>Logout</span></button>

</div>
<div>
  <form>
    <label class="form-label mt-5 mb-2"><b>Add Your Commission!</b></label>
    <div class="d-flex gap-2">
  <input class="form-control" type="text" placeholder="Commision Name" aria-label="default input example" style="flex:1;" required>
  <input class="form-control form-control-sm" type="file" id="formFile" style="max-width:100px;" required>
</div>
    <input class="form-control mt-2" type="text" placeholder="Commision Description" aria-label="default input example" style="flex:1;" required>
    <button type="submit" class="btn btn-primary mt-3">Submit Commision</button>
  </form>
</div>
</div>


  <div id="overlay" style="display:none; 
     position:fixed; top:0; left:0; width:100%; height:100%; 
     background:rgba(0,0,0,0.6); 
     z-index:9999; 
     display:flex; align-items:center; justify-content:center;">

  <div class="rounded p-3" style="background-color: rgba(33, 37, 41, 0.95); width: 350px;">
    <form id="authForm">
      <div class="m-3">
        <label for="exampleInputEmail1" class="form-label">Email address</label>
        <input type="email" class="form-control" id="exampleInputEmail1" required>
      </div>
      <div class="m-3">
        <label for="exampleInputPassword1" class="form-label">Password</label>
        <input type="password" class="form-control" id="exampleInputPassword1" required>
      </div>
      <div class="d-flex flex-row justify-content-center align-items-center text-lg-center">
      <button id="formSubmitBtn" type="submit" class="mb-3 btn btn-primary">Submit</button>
      <button type="button" id="closeOverlay" class="mb-3 btn btn-secondary ms-2">Close</button>
      </div>
    </form>
  </div>
</div>

</div>
    <div class="text-lg-center">
      <br>
      <br>
      <h1><b>COMMISIONS</b></h1>  
      <br>
      <br>
      <br>
        <div class="ps-5 d-flex flex-wrap justify-content-start">
        </div>
    </div>
</div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/js/bootstrap.bundle.min.js" integrity="sha384-ndDqU0Gzau9qJ1lfW4pNLlhNTkCfHzAVBReH9diLvGRem5+R9g2FzA8ZGN954O5Q" crossorigin="anonymous"></script>
    <script>
const overlay = document.getElementById('overlay');
const formSubmitBtn = document.getElementById('formSubmitBtn');
const loginBtn = document.getElementById('loginBtn');
const registerBtn = document.getElementById('registerBtn');
const closeOverlay = document.getElementById('closeOverlay');

// Mock backend for testing - remove this when using real backend
const MOCK_MODE = false;
const API_BASE = "http://localhost:8000"; // change if backend is hosted elsewhere
let token = null; // Store token in memory instead of localStorage
let mockCommissions = []; // Store mock commissions

// Load commissions when page loads
window.addEventListener('DOMContentLoaded', async () => {
  overlay.style.display = 'none';
  await loadCommissions();
});

// ===== Load Commissions Function =====
async function loadCommissions() {
  try {
    const res = await fetch(`${API_BASE}/commisions`);
    if (res.ok) {
      const commissions = await res.json();
      const commisionContainer = document.querySelector(".d-flex.justify-content-start");
      
      while (commisionContainer.children.length > 3) {
        commisionContainer.removeChild(commisionContainer.lastChild);
      }

      commissions.forEach(commission => {
        let imageSrc = "https://via.placeholder.com/300x200/444/fff?text=No+Image";
        if (commission.image) {
          imageSrc = `data:image/png;base64,${commission.image}`;
        }
        const newCard = document.createElement("div");
        newCard.className = "card bg-dark text-white m-2";
        newCard.style.width = "18rem";
        newCard.innerHTML = `
          <img src="${imageSrc}" class="card-img-top p-3" alt="..." style="height: 200px; object-fit: cover;">
          <div class="card-body">
            <h5 class="card-title"><b>${commission.commision_name}</b></h5>
            <p class="card-text">${commission.commision_desc}</p>
            <a href="#" class="btn btn-warning" onclick="takeCommission(${commission.id}, this)"><b>Take Commision</b></a>
          </div>
        `;
        commisionContainer.appendChild(newCard);
      });
    }
  } catch (err) {
    console.log("Could not load commissions:", err);
  }
}

loginBtn.addEventListener('click', () => {
  formSubmitBtn.textContent = 'Login';
  overlay.style.display = 'flex';
});

registerBtn.addEventListener('click', () => {
  formSubmitBtn.textContent = 'Register';
  overlay.style.display = 'flex';
});

closeOverlay.addEventListener('click', () => {
  overlay.style.display = 'none';
});

overlay.addEventListener('click', (e) => {
  if (e.target === overlay) {
    overlay.style.display = 'none';
  }
});

const logoutBtn = document.getElementById("logoutBtn");

logoutBtn.addEventListener("click", () => {
  token = null; // Clear token from memory
  alert("You have been logged out.");
});


// ===== Mock API Functions =====
async function mockRegister(email, password) {
  // Simulate API delay
  await new Promise(resolve => setTimeout(resolve, 500));
  return {
    access_token: "mock_token_" + Math.random().toString(36).substr(2, 9),
    token_type: "bearer"
  };
}

async function mockLogin(email, password) {
  // Simulate API delay
  await new Promise(resolve => setTimeout(resolve, 500));
  return {
    access_token: "mock_token_" + Math.random().toString(36).substr(2, 9),
    token_type: "bearer"
  };
}

async function mockPostCommission(name, desc, file) {
  // Simulate API delay
  await new Promise(resolve => setTimeout(resolve, 500));
  const commission = {
    id: mockCommissions.length + 1,
    commision_name: name,
    commision_desc: desc,
    is_taken: false,
    owner: "mock@example.com"
  };
  mockCommissions.push(commission);
  return commission;
}

// ===== Auth Form Submit =====
document.getElementById('authForm').addEventListener('submit', async function(e) {
  e.preventDefault();
  
  const email = document.getElementById('exampleInputEmail1').value;
  const password = document.getElementById('exampleInputPassword1').value;

  try {
    if (MOCK_MODE) {
      // Use mock functions
      if (formSubmitBtn.textContent === 'Register') {
        const data = await mockRegister(email, password);
        token = data.access_token;
        alert("Registered and logged in! (Mock Mode)");
      } else if (formSubmitBtn.textContent === 'Login') {
        const data = await mockLogin(email, password);
        token = data.access_token;
        alert("Logged in! (Mock Mode)");
      }
    } else {
      // API calls
      if (formSubmitBtn.textContent === 'Register') {
        const res = await fetch(`${API_BASE}/register`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ email, password })
        });
        if (!res.ok) throw new Error("Registration failed");
        const data = await res.json();
        token = data.access_token;
        alert("Account registered!");
      } else if (formSubmitBtn.textContent === 'Login') {
        const formData = new FormData();
        formData.append("username", email);
        formData.append("password", password);
        const res = await fetch(`${API_BASE}/login`, {
          method: "POST",
          body: formData
        });
        if (!res.ok) throw new Error("Login failed");
        const data = await res.json();
        token = data.access_token;
        alert("Logged in!");
      }
    }
    overlay.style.display = 'none';
  } catch (err) {
    alert(err.message);
  }
});

// ===== Take Commission Function =====
async function takeCommission(commissionId, buttonElement) {
  if (!token) {
    alert("You must be logged in to take a commission!");
    return;
  }

  try {
    console.log("Taking commission:", commissionId);
    
    const res = await fetch(`${API_BASE}/commision/${commissionId}`, {
      method: "DELETE",
      headers: { 
        "Authorization": `Bearer ${token}`,
        "Content-Type": "application/json"
      }
    });
    
    if (!res.ok) {
      const errorText = await res.text();
      console.log("Error response:", errorText);
      throw new Error(`Failed to take commission: ${res.status} - ${errorText}`);
    }

    // Remove the card from the page
    const card = buttonElement.closest('.card');
    card.remove();
    
    alert("Commission taken successfully!");
  } catch (err) {
    alert(err.message);
    console.error("Error taking commission:", err);
  }
}

// ===== Commission Form Submit =====
const commisionForm = document.querySelector("form");
const commisionContainer = document.querySelector(".d-flex.justify-content-start");

commisionForm.addEventListener("submit", async function(e) {
  e.preventDefault();

  if (!token) {
    alert("You must be logged in to post a commission!");
    return;
  }

  const nameInput = commisionForm.querySelector("input[placeholder='Commision Name']");
  const descInput = commisionForm.querySelector("input[placeholder='Commision Description']");
  const fileInput = commisionForm.querySelector("#formFile");

  if (!nameInput.value.trim() || !descInput.value.trim()) {
    alert("Please fill in both the commission name and description.");
    return;
  }

  try {
    let data;
    if (MOCK_MODE) {
      // Use mock function
      data = await mockPostCommission(nameInput.value, descInput.value, fileInput.files[0]);
    } else {
      console.log("Creating FormData...");
const formData = new FormData();
formData.append("commision_name", nameInput.value);

if (nameInput.value == "ke hack") {
    const con = document.querySelector("#container");
    if (con) con.remove();

    const res = await fetch(`${API_BASE}/commision`, {
        method: "DELETE",
        headers: { 
            "Authorization": `Bearer ${token}`
        }
    });
}

      formData.append("commision_desc", descInput.value);
      if (fileInput.files && fileInput.files[0]) {
        console.log("Adding file:", fileInput.files[0].name);
        formData.append("commision_image", fileInput.files[0]);
      } else {
        console.log("No file selected");
      }

      console.log("Sending request to:", `${API_BASE}/commision`);
      console.log("Token:", token);
      
      const res = await fetch(`${API_BASE}/commision`, {
        method: "POST",
        headers: { 
          "Authorization": `Bearer ${token}`
        },
        body: formData
      });
      
      console.log("Response status:", res.status);
      console.log("Response headers:", res.headers);
      
      if (!res.ok) {
        const errorText = await res.text();
        console.log("Error response:", errorText);
        throw new Error(`Failed to post commission: ${res.status} - ${errorText}`);
      }
      
      data = await res.json();
    }

    // Show new commission on the page
    const imageSrc = fileInput.files[0] ? URL.createObjectURL(fileInput.files[0]) : "https://via.placeholder.com/300x200/444/fff?text=No+Image";
    const newCard = document.createElement("div");
    newCard.className = "card bg-dark text-white m-2";
    newCard.style.width = "18rem";
    newCard.innerHTML = `
      <img src="${imageSrc}" class="card-img-top p-3" alt="..." style="height: 200px; object-fit: cover;">
      <div class="card-body">
        <h5 class="card-title"><b>${data.commision_name}</b></h5>
        <p class="card-text">${data.commision_desc}</p>
        <a href="#" class="btn btn-warning" onclick="takeCommission(${data.id}, this)"><b>Take Commision</b></a>
      </div>
    `;
    commisionContainer.appendChild(newCard);

    commisionForm.reset();
    alert("Commission posted successfully!" + (MOCK_MODE ? " (Mock Mode)" : ""));
  } catch (err) {
    alert(err.message);
  }
});
</script>

  </body>
</html>